name: Launch SSHX VM and persist disk

on:
  workflow_dispatch:

jobs:
  sshx-vm:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¾ Checkout repo
        uses: actions/checkout@v3

      - name: ğŸ“ Create persistent data folder
        run: mkdir -p vmdata

      - name: ğŸ³ Start Ubuntu VM inside Docker
        run: |
          docker run -dit --name ptero-vm \
            -v ${{ github.workspace }}/vmdata:/vmdata \
            -p 80:80 -p 443:443 -p 3000:3000 \
            ubuntu:22.04 \
            bash

      - name: âš™ï¸ Install sshx in container
        run: |
          docker exec ptero-vm bash -c "apt update && apt install curl -y && \
            curl -sL https://sshx.io/get | bash"

      - name: ğŸš€ Start SSHX shell in container
        run: |
          docker exec -it ptero-vm bash -c "./sshx --shell bash --name ptero-vm"

      - name: ğŸ’¾ Save VM state to branch
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git fetch origin
          git checkout -B vm-data
          git add vmdata
          git commit -m 'Save VM state' || echo "Nothing to commit"
          git push origin vm-data --force

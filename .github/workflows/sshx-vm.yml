name: Launch SSHX VM and persist disk

on:
  workflow_dispatch:

jobs:
  sshx-vm:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§¾ Checkout repository
        uses: actions/checkout@v3

      - name: ðŸ“¦ Install sshx
        run: |
          curl -LO https://s3.amazonaws.com/sshx/sshx-x86_64-unknown-linux-musl.tar.gz
          tar -xzf sshx-x86_64-unknown-linux-musl.tar.gz
          sudo mv sshx /usr/local/bin/sshx
          sudo chmod +x /usr/local/bin/sshx

      - name: ðŸš€ Start SSHX VM
        run: |
          sshx run -n ptero-vm --disk ./vmdata --image "ubuntu:22.04" -- -p 80:80 -p 443:443 -p 3000:3000

      - name: ðŸ’¾ Save VM state to vm-data branch
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git fetch origin
          git checkout -B vm-data
          git add vmdata
          git commit -m "Save VM state" || echo "Nothing to commit"
          git push origin vm-data --force

name: Launch SSHX VM and persist disk

on:
  workflow_dispatch:

jobs:
  sshx-vm:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # Required to switch branches

      - name: Launch SSHX VM
        run: |
          sshx --name ptero-vm --enable-readers &
          sleep 15

      - name: Switch to vm-data branch and back up
        run: |
          git fetch origin vm-data
          git checkout vm-data
          mkdir -p vmdata
          echo "Backup at $(date)" > vmdata/backup.txt
          git add vmdata/
          git config --global user.name "Auto Backup"
          git config --global user.email "actions@github.com"
          git commit -m "ðŸ’¾ Backup VM data on $(date)" || echo "Nothing to commit"
          git push origin vm-data

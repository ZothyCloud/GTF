name: Launch SSHX VM and persist disk

on:
  workflow_dispatch:

jobs:
  sshx-vm:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours max on GitHub-hosted runners

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Install SSHX
        run: |
          curl -sL https://sshx.io/get | bash
          echo "/usr/local/bin" >> $GITHUB_PATH

      - name: Launch SSHX VM
        run: |
          sshx --name ptero-vm --enable-readers &
          sleep 10

      - name: Keep the VM active (max 6 hours)
        run: |
          echo "✅ SSHX VM launched!"
          echo "⏳ Keeping the VM alive for 6 hours (max GitHub timeout)..."
          sleep 21600  # 6 hours = 6*60*60 = 21600 seconds

      - name: Backup VM data to vm-data branch
        run: |
          git fetch origin vm-data
          git checkout vm-data
          mkdir -p vmdata
          echo "Backup at $(date)" > vmdata/backup.txt
          git config --global user.name "Auto Backup"
          git config --global user.email "actions@github.com"
          git add vmdata/
          git commit -m "💾 Backup VM data on $(date)" || echo "Nothing to commit"
          git push origin vm-data

name: Launch SSHX VM and persist disk

on:
  workflow_dispatch:

jobs:
  sshx-vm:
    runs-on: ubuntu-latest

    steps:
      - name: 📦 Checkout Repository
        uses: actions/checkout@v4

      - name: 🗂️ Create persistent VM data folder
        run: mkdir -p vm-data

      - name: 🔓 Install sshx
        run: |
          curl -sL https://sshx.io/get | bash || true
          chmod +x sshx*

      - name: 🚀 Launch SSHX VM
        run: |
          ./sshx* --name ptero-vm --enable-readers &
          sleep 10

      - name: 🐳 Install Docker in SSHX VM
        run: |
          docker run -dit --name ubuntu-vm \
            -v ${{ github.workspace }}/vm-data:/data \
            ubuntu:22.04 \
            bash

          echo "✅ Ubuntu container running. Use: docker exec -it ubuntu-vm bash"

      - name: 💾 Save VM Data
        run: |
          git config --global user.name "Auto Backup"
          git config --global user.email "actions@github.com"
          git fetch origin vm-data || git checkout --orphan vm-data
          git add vm-data
          git commit -m "💾 Backup VM data on $(date '+%Y-%m-%d %H:%M:%S')" || echo "Nothing to commit"
          git push -u origin vm-data

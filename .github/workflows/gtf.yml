name: Persistent 12-Hour SSH VM

on:
  workflow_dispatch:

jobs:
  start-vm:
    runs-on: ubuntu-latest
    timeout-minutes: 720  # 12 hours
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up dependencies
        run: |
          sudo apt update
          sudo apt install -y curl npm

      - name: Start SSHX session
        id: sshx
        run: |
          npm install -g sshx
          sshx_output=$(sshx run --password GTF123 --name "ZothyVM" || true)
          echo "$sshx_output"
          echo "url=$(echo "$sshx_output" | grep -o 'https://sshx[^ ]*')" >> $GITHUB_OUTPUT

      - name: Send Discord Webhook
        if: success()
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\": \"âœ… SSHX VM started! Connect here: ${{ steps.sshx.outputs.url }}\"}" \
               ${{ secrets.DISCORD_WEBHOOK }}

      - name: Keep alive
        run: sleep 43200  # 12 hours

      - name: Backup data
        run: |
          mkdir -p save/data
          if [ -d ~/data ]; then
            cp -r ~/data/* save/data/ || true
          fi
          cd save
          git init
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git checkout -b backup
          git add .
          git commit -m "Backup at $(date)"
          git push -f https://${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} backup || true

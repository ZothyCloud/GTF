name: Persistent 12â€‘Hour SSH VM

on:
  workflow_dispatch:

jobs:
  start-vm:
    runs-on: ubuntu-latest
    timeout-minutes: 720  # 12 hours

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install Docker
      run: |
        sudo apt-get update
        sudo apt-get install -y docker.io
        sudo systemctl start docker
        sudo systemctl enable docker

    - name: Start ttyd (Web Terminal)
      run: |
        docker run -d --name ttyd -p 7681:7681 tsl0922/ttyd bash

    - name: Install Cloudflared
      run: |
        wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        sudo dpkg -i cloudflared-linux-amd64.deb

    - name: Start Cloudflare Tunnel
      run: |
        cloudflared tunnel --url http://localhost:7681 --no-autoupdate > url.log &
        sleep 5  # Give it time to generate the public URL
        grep -o 'https://.*\.trycloudflare\.com' url.log > tunnel.txt
        cat tunnel.txt

    - name: Notify Discord with Tunnel URL
      env:
        WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK }}
      run: |
        TUNNEL_URL=$(cat tunnel.txt)
        curl -H "Content-Type: application/json" \
          -X POST \
          -d "{\"content\": \"ðŸš€ Your Web Terminal is Live: $TUNNEL_URL\"}" \
          $WEBHOOK_URL

    - name: Keep VM Alive
      run: sleep 43200  # 12 hours

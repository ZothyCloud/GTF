name: Persistent 12‑Hour SSH VM

on:
  workflow_dispatch:

jobs:
  start-vm:
    runs-on: ubuntu-latest
    timeout-minutes: 720

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install ttyd and Docker
      run: |
        sudo apt update
        sudo apt install -y ttyd docker.io

    - name: Start Terminal Server
      id: ttyd
      run: |
        docker run -d --name gtf-ttyd \
          -p 7681:7681 \
          alpine/sh -c "apk add --no-cache bash && ttyd -p 7681 bash"
        url="http://localhost:7681"
        echo "url=$url" >> $GITHUB_OUTPUT

    - name: Send Discord Notification
      if: success()
      run: |
        curl -H "Content-Type: application/json" \
          -X POST \
          -d "{\"content\": \"✅ VM terminal live! Access via: ${{ steps.ttyd.outputs.url }}\"}" \
          ${{ secrets.DISCORD_WEBHOOK }}

    - name: Keep VM Alive
      run: sleep 43200  # 12 hours

    - name: Backup VM Data
      run: |
        mkdir -p save/data
        if [ -d ~/data ]; then
          cp -r ~/data/* save/data/ || true
        fi
        cd save
        git init
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git checkout -b backup
        git add .
        git commit -m "Backup $(date)" || echo "No changes"
        git push -f https://${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} backup

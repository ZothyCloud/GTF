name: Persistent 12-Hour SSH VM

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

jobs:
  start-vm:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - uses: actions/checkout@v3

      - name: Restore Previous Files
        run: |
          mkdir -p ~/data
          git clone --depth 1 --branch backup https://github.com/${{ github.repository }} restore || true
          cp -r restore/data/* ~/data/ || true

      - name: Install Node & SSHX
        run: |
          curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
          sudo apt-get install -y nodejs git
          npm install -g sshx@1.1.0

      - name: Start SSHX Session
        run: |
          sshx --once &
          echo "ðŸ”— SSHX Tunnel Started â€” session will persist until manually closed"

      - name: Save Data Backup
        if: always()
        run: |
          mkdir -p save/data
          cp -r ~/data/* save/data/ || true
          cd save
          git init
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}
          git checkout -B backup
          git add .
          git commit -m "Auto backup $(date)"
          git push -f origin backup

name: Persistent 12-Hour SSH VM

on:
  workflow_dispatch:

jobs:
  start-vm:
    runs-on: ubuntu-latest
    timeout-minutes: 720

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install Docker (Safe Method)
      run: |
        curl -fsSL https://get.docker.com | bash
        sudo systemctl start docker
        sudo systemctl enable docker

    - name: Start ttyd (Web Terminal)
      run: |
        docker run -d --name ttyd -p 7681:7681 tsl0922/ttyd bash

    - name: Install Cloudflared
      run: |
        wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        sudo dpkg -i cloudflared-linux-amd64.deb

    - name: Start Cloudflare Tunnel
      run: |
        cloudflared tunnel --url http://localhost:7681 --no-autoupdate > url.log &
        sleep 10
        grep -o 'https://.*\.trycloudflare\.com' url.log > tunnel.txt || echo "No URL found"
        cat tunnel.txt

    - name: Send Webhook Notification
      env:
        WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK }}
      run: |
        TUNNEL_URL=$(cat tunnel.txt | head -n 1)
        if [ -z "$TUNNEL_URL" ]; then
          TUNNEL_URL="‚ùå Failed to fetch tunnel URL"
        fi
        curl -H "Content-Type: application/json" \
          -X POST \
          -d "{\"content\": \"üîó Terminal ready: $TUNNEL_URL\"}" \
          $WEBHOOK_URL

    - name: Keep Alive for 12 Hours
      run: sleep 43200
